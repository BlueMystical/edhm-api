<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="author" content="BlueMystic - 2022">
    <meta name="copyright" content="EDHM_UI">
    <meta name="description" content="Statistics Chart">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Statistics Chart</title>

    <!-- https://www.chartjs.org/docs/3.2.0/ -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/chart.js@3.8.0/dist/chart.min.js"></script>
</head>

<body>

    <label id="lblUsersCount" for="CountriesChart"></label>
    <canvas id="CountriesChart" height="200", width="400"></canvas>
    <canvas id="LanguagesChart" height="200", width="400"></canvas>
    <canvas id="OdysseyChart"  height="200", width="400"></canvas>
    <canvas id="GameModeChart" height="200", width="400"></canvas>

    <script>        
        try {
            //Here we get the URL Params and set their default Values:
            const urlParams = new URLSearchParams(window.location.search);
            var ChartType = urlParams.get('type');
            var ChartHeight = urlParams.get('height');
            var ChartWidth = urlParams.get('width');

            if (!ChartType) ChartType = 'doughnut';
            if (!ChartHeight) ChartHeight = '200';
            if (!ChartWidth) ChartWidth = '400';

            console.log('url param: [type], (bar, line, pie, doughnut, radar, polarArea, bubble, scatter), Current: ' + ChartType);
            console.log('url param: [height], (height of the Charts), Current: ' + ChartHeight); 
            console.log('url param: [width], (width of the Charts), Current: ' + ChartWidth);
            console.log('Chart.js docs at https://www.chartjs.org/docs/3.2.0/');

            //Here we get the Data for the Charts:
            var myRequest = new Request('/users/get-statistics', {
                method: 'GET',
                headers: new Headers(),
                mode: 'cors',
                cache: 'no-cache'
            });
            fetch(myRequest).then(function (response) {
                var contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    return response.json().then(function (json) {
                        var mData = json.result;
                        //This are the Colors for the different 'Series' shown in the Charts:
                        var barColors = ["#2980B9", "#48C9B0", "#F4D03F", "#CD6155", "#DC7633", "#566573", "#BB8FCE", "#85C1E9", "#F8C471", "#D2B4DE", "#E5E7E9", "#D35400", "#641E16", "#1F618D", "#F1C40F", "#F08080", "#FB8FF1", "#B3B6B7"];

                        //1. Grafico para los Paises:
                        if (typeof mData.Countries != 'undefined') {
                            var xValues = [];
                            var yValues = [];

                            mData.Countries.forEach(country => {
                                xValues.push(country.Value);
                                yValues.push(country.Count);
                            });

                            var ctx = document.getElementById('CountriesChart');
                            ctx.setAttribute('height', ChartHeight);
                            ctx.setAttribute('width', ChartWidth);
                            var myChart = new Chart(ctx.getContext('2d'), {
                                type: ChartType,
                                data: {
                                    labels: xValues,
                                    datasets: [{
                                        backgroundColor: barColors,
                                        data: yValues
                                    }]
                                },
                                options: {
                                    plugins: {
                                        legend: { 
                                            display: (ChartType === 'doughnut' || ChartType === 'pie') ? true : false, 
                                            position: 'right' 
                                        },
                                        title: {
                                            display: true,
                                            text: "EDHM_UI by Countries"
                                        }
                                    },
                                    maintainAspectRatio: false,
                                    responsive: false,
                                    scales: {
                                        y: {
                                            display: (ChartType === 'doughnut' || ChartType === 'pie') ? false : true, 
                                            beginAtZero: true
                                        }
                                    }
                                }
                            });
                        }

                        //2. Grafico para los Lenguajes:
                        if (typeof mData.Languages != 'undefined') {
                            var xValues = [];
                            var yValues = [];

                            mData.Languages.forEach(country => {
                                xValues.push(country.Value);
                                yValues.push(country.Count);
                            });

                            var ctx = document.getElementById('LanguagesChart');
                            ctx.setAttribute('height', ChartHeight);
                            ctx.setAttribute('width', ChartWidth);
                            var myChart = new Chart(ctx.getContext('2d'), {
                                type: ChartType,
                                data: {
                                    labels: xValues,
                                    datasets: [{
                                        backgroundColor: barColors,
                                        data: yValues
                                    }]
                                },
                                options: {
                                    plugins: {
                                        legend: { 
                                            display: (ChartType === 'doughnut' || ChartType === 'pie') ? true : false, 
                                            position: 'right' 
                                        },
                                        title: {
                                            display: true,                                            
                                            text: "EDHM_UI by Languages"
                                        }
                                    },
                                    maintainAspectRatio: false,
                                    responsive: false,
                                    scales: {
                                        y: {
                                            display: (ChartType === 'doughnut' || ChartType === 'pie') ? false : true, 
                                            beginAtZero: true
                                        }
                                    }
                                }
                            });
                        }

                        //3. Grafico para los que usan Odyssey:
                        if (typeof mData.Odyssey != 'undefined') {
                            var xValues = [];
                            var yValues = [];

                            mData.Odyssey.forEach(country => {
                                xValues.push(country.Value);
                                yValues.push(country.Count);
                            });

                            var ctx = document.getElementById('OdysseyChart');
                            ctx.setAttribute('height', ChartHeight);
                            ctx.setAttribute('width', ChartWidth);
                            var myChart = new Chart(ctx.getContext('2d'), {
                                type: ChartType,
                                data: {
                                    labels: xValues,
                                    datasets: [{
                                        backgroundColor: barColors,
                                        data: yValues
                                    }]
                                },
                                options: {
                                    plugins: {
                                        legend: { 
                                            display: (ChartType === 'doughnut' || ChartType === 'pie') ? true : false, 
                                            position: 'right' 
                                        },
                                        title: {
                                            display: true,
                                            text: "EDHM_UI by Game Version"
                                        }
                                    },
                                    maintainAspectRatio: false,
                                    responsive: false,
                                    scales: {
                                        y: {
                                            display: (ChartType === 'doughnut' || ChartType === 'pie') ? false : true, 
                                            beginAtZero: true
                                        }
                                    }
                                }
                            });
                        }

                        //4. Grafico para el GameMode:
                        if (typeof mData.GameMode != 'undefined') {
                            var xValues = [];
                            var yValues = [];

                            mData.GameMode.forEach(country => {
                                xValues.push(country.Value);
                                yValues.push(country.Count);
                            });

                            var ctx = document.getElementById('GameModeChart');
                            ctx.setAttribute('height', ChartHeight);
                            ctx.setAttribute('width', ChartWidth);
                            var myChart = new Chart(ctx.getContext('2d'), {
                                type: ChartType,
                                data: {
                                    labels: xValues,
                                    datasets: [{
                                        backgroundColor: barColors,
                                        data: yValues
                                    }]
                                },
                                options: {
                                    plugins: {
                                        legend: { 
                                            display: (ChartType === 'doughnut' || ChartType === 'pie') ? true : false, 
                                            position: 'right' 
                                        },
                                        title: {
                                            display: true,
                                            text: "EDHM_UI by GameMode"
                                        }
                                    },
                                    maintainAspectRatio: false,
                                    responsive: false,
                                    scales: {
                                        y: {
                                            display: (ChartType === 'doughnut' || ChartType === 'pie') ? false : true, 
                                            beginAtZero: true
                                        }
                                    }
                                }
                            });
                        }
                    
                        document.getElementById('lblUsersCount').innerHTML = '<h2>' + mData.UserCount + ' Records.</h2>';

                    });
                } else {
                    console.log("Oops, we haven't got JSON!");
                }
            })
            .catch(error => console.error('Error:', error));
        } catch (error) {
            console.log(error);
        }
    </script>

</body>

</html>